// Code generated by goa v3.8.4, DO NOT EDIT.
//
// ProgLog gRPC server
//
// Command:
// $ goa gen proglog/design

package server

import (
	"context"
	"errors"
	prog_logpb "proglog/gen/grpc/prog_log/pb"
	proglog "proglog/gen/prog_log"

	goagrpc "goa.design/goa/v3/grpc"
	goa "goa.design/goa/v3/pkg"
	"google.golang.org/grpc/codes"
)

// Server implements the prog_logpb.ProgLogServer interface.
type Server struct {
	ProduceH       goagrpc.UnaryHandler
	ConsumeH       goagrpc.UnaryHandler
	ProduceStreamH goagrpc.StreamHandler
	ConsumeStreamH goagrpc.StreamHandler
	prog_logpb.UnimplementedProgLogServer
}

// ErrorNamer is an interface implemented by generated error structs that
// exposes the name of the error as defined in the expr.
type ErrorNamer interface {
	ErrorName() string
}

// ProduceStreamServerStream implements the proglog.ProduceStreamServerStream
// interface.
type ProduceStreamServerStream struct {
	stream prog_logpb.ProgLog_ProduceStreamServer
	view   string
}

// ConsumeStreamServerStream implements the proglog.ConsumeStreamServerStream
// interface.
type ConsumeStreamServerStream struct {
	stream prog_logpb.ProgLog_ConsumeStreamServer
	view   string
}

// New instantiates the server struct with the ProgLog service endpoints.
func New(e *proglog.Endpoints, uh goagrpc.UnaryHandler, sh goagrpc.StreamHandler) *Server {
	return &Server{
		ProduceH:       NewProduceHandler(e.Produce, uh),
		ConsumeH:       NewConsumeHandler(e.Consume, uh),
		ProduceStreamH: NewProduceStreamHandler(e.ProduceStream, sh),
		ConsumeStreamH: NewConsumeStreamHandler(e.ConsumeStream, sh),
	}
}

// NewProduceHandler creates a gRPC handler which serves the "ProgLog" service
// "Produce" endpoint.
func NewProduceHandler(endpoint goa.Endpoint, h goagrpc.UnaryHandler) goagrpc.UnaryHandler {
	if h == nil {
		h = goagrpc.NewUnaryHandler(endpoint, DecodeProduceRequest, EncodeProduceResponse)
	}
	return h
}

// Produce implements the "Produce" method in prog_logpb.ProgLogServer
// interface.
func (s *Server) Produce(ctx context.Context, message *prog_logpb.ProduceRequest) (*prog_logpb.ProduceResponse, error) {
	ctx = context.WithValue(ctx, goa.MethodKey, "Produce")
	ctx = context.WithValue(ctx, goa.ServiceKey, "ProgLog")
	resp, err := s.ProduceH.Handle(ctx, message)
	if err != nil {
		return nil, goagrpc.EncodeError(err)
	}
	return resp.(*prog_logpb.ProduceResponse), nil
}

// NewConsumeHandler creates a gRPC handler which serves the "ProgLog" service
// "Consume" endpoint.
func NewConsumeHandler(endpoint goa.Endpoint, h goagrpc.UnaryHandler) goagrpc.UnaryHandler {
	if h == nil {
		h = goagrpc.NewUnaryHandler(endpoint, DecodeConsumeRequest, EncodeConsumeResponse)
	}
	return h
}

// Consume implements the "Consume" method in prog_logpb.ProgLogServer
// interface.
func (s *Server) Consume(ctx context.Context, message *prog_logpb.ConsumeRequest) (*prog_logpb.ConsumeResponse, error) {
	ctx = context.WithValue(ctx, goa.MethodKey, "Consume")
	ctx = context.WithValue(ctx, goa.ServiceKey, "ProgLog")
	resp, err := s.ConsumeH.Handle(ctx, message)
	if err != nil {
		return nil, goagrpc.EncodeError(err)
	}
	return resp.(*prog_logpb.ConsumeResponse), nil
}

// NewProduceStreamHandler creates a gRPC handler which serves the "ProgLog"
// service "ProduceStream" endpoint.
func NewProduceStreamHandler(endpoint goa.Endpoint, h goagrpc.StreamHandler) goagrpc.StreamHandler {
	if h == nil {
		h = goagrpc.NewStreamHandler(endpoint, nil)
	}
	return h
}

// ProduceStream implements the "ProduceStream" method in
// prog_logpb.ProgLogServer interface.
func (s *Server) ProduceStream(stream prog_logpb.ProgLog_ProduceStreamServer) error {
	ctx := stream.Context()
	ctx = context.WithValue(ctx, goa.MethodKey, "ProduceStream")
	ctx = context.WithValue(ctx, goa.ServiceKey, "ProgLog")
	_, err := s.ProduceStreamH.Decode(ctx, nil)
	if err != nil {
		return goagrpc.EncodeError(err)
	}
	ep := &proglog.ProduceStreamEndpointInput{
		Stream: &ProduceStreamServerStream{stream: stream},
	}
	err = s.ProduceStreamH.Handle(ctx, ep)
	if err != nil {
		return goagrpc.EncodeError(err)
	}
	return nil
}

// NewConsumeStreamHandler creates a gRPC handler which serves the "ProgLog"
// service "ConsumeStream" endpoint.
func NewConsumeStreamHandler(endpoint goa.Endpoint, h goagrpc.StreamHandler) goagrpc.StreamHandler {
	if h == nil {
		h = goagrpc.NewStreamHandler(endpoint, DecodeConsumeStreamRequest)
	}
	return h
}

// ConsumeStream implements the "ConsumeStream" method in
// prog_logpb.ProgLogServer interface.
func (s *Server) ConsumeStream(message *prog_logpb.ConsumeStreamRequest, stream prog_logpb.ProgLog_ConsumeStreamServer) error {
	ctx := stream.Context()
	ctx = context.WithValue(ctx, goa.MethodKey, "ConsumeStream")
	ctx = context.WithValue(ctx, goa.ServiceKey, "ProgLog")
	p, err := s.ConsumeStreamH.Decode(ctx, message)
	if err != nil {
		var en ErrorNamer
		if errors.As(err, &en) {
			switch en.ErrorName() {
			case "OffsetOutOfRange":
				return goagrpc.NewStatusError(codes.OutOfRange, err, goagrpc.NewErrorResponse(err))
			}
		}
		return goagrpc.EncodeError(err)
	}
	ep := &proglog.ConsumeStreamEndpointInput{
		Stream:  &ConsumeStreamServerStream{stream: stream},
		Payload: p.(*proglog.ConsumeRequest),
	}
	err = s.ConsumeStreamH.Handle(ctx, ep)
	if err != nil {
		var en ErrorNamer
		if errors.As(err, &en) {
			switch en.ErrorName() {
			case "OffsetOutOfRange":
				return goagrpc.NewStatusError(codes.OutOfRange, err, goagrpc.NewErrorResponse(err))
			}
		}
		return goagrpc.EncodeError(err)
	}
	return nil
}

// Send streams instances of "prog_logpb.ProduceStreamResponse" to the
// "ProduceStream" endpoint gRPC stream.
func (s *ProduceStreamServerStream) Send(res *proglog.Produceresponse) error {
	vres := proglog.NewViewedProduceresponse(res, "default")
	v := NewProtoProduceStreamResponse(vres.Projected)
	return s.stream.Send(v)
}

// Recv reads instances of "prog_logpb.ProduceStreamStreamingRequest" from the
// "ProduceStream" endpoint gRPC stream.
func (s *ProduceStreamServerStream) Recv() (*proglog.ProduceRequest, error) {
	var res *proglog.ProduceRequest
	v, err := s.stream.Recv()
	if err != nil {
		return res, err
	}
	if err = ValidateProduceStreamStreamingRequest(v); err != nil {
		return res, err
	}
	return NewProduceRequest(v), nil
}

func (s *ProduceStreamServerStream) Close() error {
	// nothing to do here
	return nil
}

// Send streams instances of "prog_logpb.ConsumeStreamResponse" to the
// "ConsumeStream" endpoint gRPC stream.
func (s *ConsumeStreamServerStream) Send(res *proglog.Consumeresponse) error {
	vres := proglog.NewViewedConsumeresponse(res, "default")
	v := NewProtoConsumeStreamResponse(vres.Projected)
	return s.stream.Send(v)
}

func (s *ConsumeStreamServerStream) Close() error {
	// nothing to do here
	return nil
}
